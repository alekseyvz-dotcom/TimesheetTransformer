name: Test Supabase DB connection (IPv4 forced)

on:
  workflow_dispatch: {}

jobs:
  db-check:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --dns-result-order=ipv4first
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pg client
        run: npm install pg@8

      - name: Run connection test (force IPv4 via DoH)
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          node <<'JS'
          (async () => {
            const https = require('https');
            const { URL } = require('url');
            const { Client } = require('pg');

            function dohResolveA(host) {
              return new Promise((resolve, reject) => {
                const url = `https://dns.google/resolve?name=${encodeURIComponent(host)}&type=A`;
                https.get(url, res => {
                  let data = '';
                  res.on('data', d => data += d);
                  res.on('end', () => {
                    try {
                      const j = JSON.parse(data);
                      const ans = (j.Answer || []).find(a => a.type === 1 && a.data);
                      if (ans && ans.data) {
                        resolve(ans.data.trim());
                      } else {
                        reject(new Error('No A record in DoH response'));
                      }
                    } catch (e) {
                      reject(e);
                    }
                  });
                }).on('error', reject);
              });
            }

            try {
              let url = process.env.DATABASE_URL;
              if (!url) throw new Error('DATABASE_URL is empty');
              const u = new URL(url);
              const host = u.hostname;
              const port = u.port || '5432';

              // IPv4 через DoH
              let ipv4;
              try {
                ipv4 = await dohResolveA(host);
                console.log('Resolved IPv4 via DoH:', host, '->', ipv4);
              } catch (e) {
                console.warn('DoH A lookup failed:', e.message);
              }

              // Подключаемся к IP, но выставляем SNI servername=оригинальному host
              const client = ipv4
                ? new Client({
                    connectionString: url,
                    host: ipv4,
                    port: Number(port),
                    ssl: { rejectUnauthorized: false, servername: host }
                  })
                : new Client({
                    connectionString: url,
                    ssl: { rejectUnauthorized: false }
                  });

              await client.connect();
              const ver = await client.query('select version()');
              console.log('Connected OK:', ver.rows[0].version);
              const now = await client.query('select now() as now');
              console.log('Server time:', now.rows[0].now);
              await client.query('create table if not exists healthcheck_test(id serial primary key, created_at timestamp default now())');
              await client.query('insert into healthcheck_test default values');
              const cnt = await client.query('select count(*) from healthcheck_test');
              console.log('Rows in healthcheck_test:', cnt.rows[0].count);
              await client.end();
              console.log('All good.');
            } catch (e) {
              console.error('DB check failed:', e);
              process.exit(1);
            }
          })();
          JS
