name: Build EXE (Unified)

on:
  workflow_dispatch:
  push:
    paths:
      - main_app.py
      - timesheet_transformer.py
      - SpecialOrders.py
      - assets_logo.py
      - BudgetAnalyzer.py
      # ... (остальные файлы) ...

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ... (Установка Python, Cache pip, Install dependencies) ...
      
      # (Шаг Install dependencies остается без изменений)

      - name: Clean previous build folders
        shell: pwsh
        run: |
          if (Test-Path dist)  { Remove-Item -Recurse -Force dist }
          if (Test-Path build) { Remove-Item -Recurse -Force build }

      # --- Шаг генерации assets_logo.py остается без изменений ---

      - name: Build Unified TabelSuite Executable
        shell: pwsh
        run: |
          # 1. Основные аргументы: -D (onedir) для минимизации размера
          #    Если хотите только один файл, используйте -F
          $args = @("-D", "-w", "--clean", "-n", "TabelSuite") 

          # 2. Явное включение всех дочерних скриптов (плагинов)
          #    Это заставляет PyInstaller анализировать их зависимости (Openpyxl, Pandas и т.д.)
          $args += @("--hidden-import=BudgetAnalyzer", 
                    "--hidden-import=SpecialOrders", 
                    "--hidden-import=timesheet_transformer")

          # 3. Обеспечение включения Pandas/Openpyxl (для главного меню и аналитики)
          $args += @("--collect-all", "pandas",
                    "--collect-all", "openpyxl")
          
          # 4. Добавление иконки и основного скрипта
          if (Test-Path "icon.ico") {
            $args += @("-i", "icon.ico")
          } else {
            Write-Host "icon.ico not found: building TabelSuite without custom icon"
          }
          
          # Указываем PyInstaller, что BudgetAnalyzer.py, SpecialOrders.py, timesheet_transformer.py 
          # являются вспомогательными файлами для main_app.py
          $args += @("--collect-all", "BudgetAnalyzer",
                    "--collect-all", "SpecialOrders",
                    "--collect-all", "timesheet_transformer",
                    "main_app.py")
          
          # Выполняем PyInstaller с помощью оператора вызова (&)
          & pyinstaller $args


      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          # Загружаем только папку dist, которая содержит TabelSuite.exe и все DLL
          name: TabelSuite_Unified_Package 
          path: dist/TabelSuite
          if-no-files-found: error
          retention-days: 14
